#!/bin/bash
LOG_FILE="${TRIM_DATA_SHARE_PATHS%%:*}/info.log"
PID_FILE="${TRIM_PKGVAR}/app.pid"
BITCOMET_FILE="${TRIM_APPDEST}/bin/bitcometd"
WEBUI_DIR="${TRIM_APPDEST}/share/webui"
IP_DIR="${TRIM_APPDEST}/share/ip2location"

CMD="${TRIM_APPDEST}/bin/bitcometd"

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

# --- 从文件名提取版本号的函数 ---
extract_version_from_filename() {
    local filename="$1"
    # 提取 BitComet-<version>-<arch>.deb 中的 <version>
    local version=$(echo "$filename" | sed -n 's/^BitComet-\([^-]*\)-.*\.deb$/\1/p')
    echo "$version"
}

#=== 启动前检查必需文件 ===
if [ ! -f "$BITCOMET_FILE" ] || [ ! -d "$WEBUI_DIR" ] || [ ! -d "$IP_DIR" ]; then
    echo "缺少运行必需文件，进行安装" >> ${LOG_FILE}

    #=== 释放运行必需文件 ===
    #--- 检测并复制deb安装包 ---
    mkdir -p ${TRIM_APPDEST}/tmp
    mkdir -p ${TRIM_APPDEST}/tmp/extracted
    APP_DIR="${TRIM_DATA_SHARE_PATHS%%:*}/app"
    TMP_DIR="${TRIM_APPDEST}/tmp"
    DEB_PATH=$(find "$APP_DIR" -maxdepth 1 -type f -name "BitComet-*-*.deb" -print -quit)

    if [ -z "$DEB_PATH" ]; then
       echo "错误：在$APP_DIR中未找到匹配 'BitComet-xxxx-xxxx.deb' 格式的文件。" >> ${LOG_FILE}
       echo "错误：在$APP_DIR中未找到匹配 'BitComet-xxxx-xxxx.deb' 格式的文件。" >&2
       exit 1
    fi
    cp "$DEB_PATH" "$TMP_DIR/bitcomet.deb"

    #--- 获取安装文件的版本号 ---
    CURRENT_VERSION_FILE="${TRIM_APPDEST}/current_version"
    FOUND_FILENAME=$(basename "$DEB_PATH")
    FOUND_VERSION=$(extract_version_from_filename "$FOUND_FILENAME")

    if [ -z "$FOUND_VERSION" ]; then
        log_msg "错误：无法从文件名 '$FOUND_FILENAME' 中提取版本号。"
        exit 1
    fi

    log_msg "提取到的版本号: $FOUND_VERSION"
    echo "$FOUND_VERSION" > "$CURRENT_VERSION_FILE"

    #--- 解压deb安装包 ---
    echo "正在解压 $TMP_DIR/bitcomet.deb 到 $TMP_DIR/extracted ..." >> ${LOG_FILE}
    if command -v dpkg-deb &> /dev/null; then
        echo "使用 dpkg-deb 解压..." >> ${LOG_FILE}
        dpkg-deb -x "$TMP_DIR/bitcomet.deb" "$TMP_DIR/extracted/"
        echo "解压成功" >> ${LOG_FILE}
    else
        echo "解压失败" >> ${LOG_FILE}
        exit 1
    fi
    #--- 提取bitcometd ---
    BIN_DIR="${TRIM_APPDEST}/bin"
    BITCOMETD_PATH=$(find "$TMP_DIR/extracted" -type f -name "bitcometd" -print -quit)

    if [ -n "$BITCOMETD_PATH" ]; then
        cp "$BITCOMETD_PATH" "$BIN_DIR/bitcometd"
    else
        echo "在 $TMP_DIR 及其子目录中未找到名为 'bitcometd' 的文件。" >> ${LOG_FILE}
        echo "在 $TMP_DIR 及其子目录中未找到名为 'bitcometd' 的文件。" >&2
        exit 1
    fi

    #--- 提取webui和ip2location文件夹
    WEBUI_PATH=$(find "$TMP_DIR/extracted" -type d -name "webui" -print -quit)

    if [ -n "$WEBUI_PATH" ]; then
        cp -r "$WEBUI_PATH" "$TRIM_APPDEST/share/webui"
    else
        echo "在 $TMP_DIR 及其子目录中未找到名为 'webui' 的目录。" >> ${LOG_FILE}
        echo "在 $TMP_DIR 及其子目录中未找到名为 'webui' 的目录。" >&2
        exit 1
    fi

    IP_PATH=$(find "$TMP_DIR/extracted" -type d -name "ip2location" -print -quit)

    if [ -n "$IP_PATH" ]; then
        cp -r "$IP_PATH" "$TRIM_APPDEST/share/ip2location"
    else
        echo "在 $TMP_DIR 及其子目录中未找到名为 'ip2location' 的目录。" >> ${LOG_FILE}
        echo "在 $TMP_DIR 及其子目录中未找到名为 'ip2location' 的目录。" >&2
        exit 1
    fi
else
    echo "所有必需的文件和目录均已存在，继续启动" >> ${LOG_FILE}
fi

#--- 清空临时文件 ---
rm -f ${DEB_PATH}
rm -rf ${TMP_DIR}

start_process() {
    if status; then
        return 0
    fi

    log_msg "创建软链接并启动bitcometd"
    #--- 创建文件夹软链接 ----
    USER_SHARE="${TRIM_APPDEST}/share"
    USER_CONFIG="${TRIM_DATA_SHARE_PATHS%%:*}/data"
    USER_DOWNLOAD="${TRIM_DATA_SHARE_PATHS%%:*}/Download"
    BITCOMET_SHARE="/usr/share/bitcomet"
    BITCOMET_CONFIG="/root/.config/BitComet"
    BITCOMET_DOWNLOAD="/root/Downloads"

    # 检查并清理目标路径上的旧软链接
    if [ -L "$BITCOMET_SHARE" ]; then
        echo "发现并删除已存在的软链接: $BITCOMET_SHARE" >> ${LOG_FILE}
        rm -f "$BITCOMET_SHARE"
    fi
    if ln -s "$USER_SHARE" "$BITCOMET_SHARE"; then
      echo "成功创建$BITCOMET_SHARE" >> ${LOG_FILE}
    else
      echo "错误: 创建$BITCOMET_SHARE失败 (退出码: $?)。请检查权限和父目录是否存在。" >> ${LOG_FILE}
      exit 1
    fi

    # 检查并清理目标路径上的旧软链接
    if [ -L "$BITCOMET_DOWNLOAD" ]; then
        echo "发现并删除已存在的软链接: $BITCOMET_DOWNLOAD" >> ${LOG_FILE}
        rm -f "$BITCOMET_DOWNLOAD"
    fi
    if ln -s "$USER_DOWNLOAD" "$BITCOMET_DOWNLOAD"; then
      echo "成功创建$BITCOMET_DOWNLOAD" >> ${LOG_FILE}
    else
      echo "错误: 创建$BITCOMET_DOWNLOAD失败 (退出码: $?)。请检查权限和父目录是否存在。" >> ${LOG_FILE}
      exit 1
    fi

    # 检查并清理目标路径上的旧软链接
    if [ -L "$BITCOMET_CONFIG" ]; then
        echo "发现并删除已存在的软链接: $BITCOMET_CONFIG" >> ${LOG_FILE}
        rm -f "$BITCOMET_CONFIG"
    fi
    if ln -s "$USER_CONFIG" "$BITCOMET_CONFIG"; then
      echo "成功创建$BITCOMET_CONFIG" >> ${LOG_FILE}
    else
      echo "错误: 创建$BITCOMET_CONFIG失败 (退出码: $?)。请检查权限和父目录是否存在。" >> ${LOG_FILE}
      exit 1
    fi

    # run cmd to start process
    bash -c "${CMD}" >> ${LOG_FILE} 2>&1 &
    # write pid to pidfile
    printf "%s" "$!" > ${PID_FILE}
    # log_msg "CMD = ${CMD}"
    # log_msg "pid = $!"
    return 0
}

stop_process() {
    log_msg "停止bitcometd并卸载软链接...."

    if [ -r "${PID_FILE}" ]; then
        pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')
        
        log_msg "pid=${pid}"
        if ! check_process "${pid}"; then
            # process not exist, delete pidfile
            rm -f "${PID_FILE}"
            log_msg "remove pid file 1"
            return
        fi

        log_msg "send TERM signal to PID:${pid}..."
        kill -TERM ${pid} >> ${LOG_FILE} 2>&1

        local count=0
        while check_process "${pid}" && [ $count -lt 10 ]; do
            sleep 1
            count=$((count + 1))
            log_msg "waiting process terminal... (${count}s/10s)"
        done

        if check_process "${pid}"; then
            log_msg "send KILL signal to PID:${pid}..."
            kill -KILL "${pid}"
            sleep 1
            rm -f "${PID_FILE}"
        else
            log_msg "process killed... "
        fi
    fi
    # 检查并删除第一个软链接
    if [ -L "${BITCOMET_SHARE}" ]; then
        if [ "$(readlink "${BITCOMET_SHARE}")" = "${USER_SHARE}" ]; then
            echo "发现并删除软链接: ${BITCOMET_SHARE} -> $(readlink "${BITCOMET_SHARE}")"
           rm -f "${BITCOMET_SHARE}"
        else
            echo "警告: ${BITCOMET_SHARE} 存在但不是由本脚本创建的 (目标: $(readlink "${BITCOMET_SHARE}")). 跳过。"
        fi
    else
        echo "未找到软链接: ${BITCOMET_SHARE} (或它不是一个链接)"
    fi

    # 检查并删除第二个软链接
    if [ -L "${BITCOMET_CONFIG}" ]; then
        if [ "$(readlink "${BITCOMET_CONFIG}")" = "${USER_CONFIG}" ]; then
            echo "发现并删除软链接: ${BITCOMET_CONFIG} -> $(readlink "${BITCOMET_CONFIG}")"
            rm -f "${BITCOMET_CONFIG}"
        else
            echo "警告: ${BITCOMET_CONFIG} 存在但不是由本脚本创建的 (目标: $(readlink "${BITCOMET_CONFIG}")). 跳过。"
        fi
    else
        echo "未找到软链接: ${BITCOMET_CONFIG} (或它不是一个链接)"
    fi

    # 检查并删除第三个软链接
    if [ -L "${BITCOMET_DOWNLOAD}" ]; then
        if [ "$(readlink "${BITCOMET_DOWNLOAD}")" = "${USER_DOWNLOAD}" ]; then
            echo "发现并删除软链接: ${BITCOMET_DOWNLOAD} -> $(readlink "${BITCOMET_DOWNLOAD}")"
            rm -f "${BITCOMET_DOWNLOAD}"
        else
            echo "警告: ${BITCOMET_DOWNLOAD} 存在但不是由本脚本创建的 (目标: $(readlink "${BITCOMET_DOWNLOAD}")). 跳过。"
        fi
    else
        echo "未找到软链接: ${BITCOMET_DOWNLOAD} (或它不是一个链接)"
    fi

    echo "停止进程并软链接清理完成。" >> ${LOG_FILE}
    return 0
}

check_process() {
    local pid=$1
    if kill -0 "${pid}" 2>/dev/null; then
        return 0  # process exist
    else
        return 1  # process not exist
    fi
}

status() {
    if [ -f "${PID_FILE}" ]; then
        pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')
        if check_process "${pid}"; then
            return 0
        else
            # Process is not running but pidfile exists - clean it up
            rm -f "${PID_FILE}"
        fi    
    fi

    return 1
}

case $1 in
start)
    # run start command. exit 0 if success, exit 1 if failed
    start_process
    ;;
stop)
    # run stop command. exit 0 if success, exit 1 if failed
    stop_process
    ;;
status)
    # check application status command. exit 0 if running, exit 3 if not running
    if status; then 
        exit 0
    else 
        exit 3
    fi
    ;;
*)
    exit 1
    ;;
esac